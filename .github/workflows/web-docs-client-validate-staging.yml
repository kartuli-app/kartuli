name: Web Docs Client Validate (Staging)

# Staging validation workflow:
# - mirrors production generation/build/copy steps
# - intentionally excludes deploy
# - catches dependency/tooling regressions (lock/workspace/package updates)
on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'tools/web-docs-client/**'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'package.json'
      - '.github/workflows/web-docs-client-validate-staging.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'tools/web-docs-client/**'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'package.json'
      - '.github/workflows/web-docs-client-validate-staging.yml'

permissions:
  contents: read

jobs:
  validate:
    name: web-docs-client-validate-staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Generate links-only LLM bundle from docs navigation/frontmatter.
      - name: Generate LLM bundle
        run: node tools/web-docs-client/scripts/generate-llm-bundle.js

      # Build docs using repository-level docs build command.
      - name: Build docs
        run: pnpm run c:build:docs

      # Copy bundle into built assets so llms.txt link works in built output.
      - name: Copy LLM bundle to built assets
        run: node tools/web-docs-client/scripts/copy-llm-bundle.js

      # Validate key output artifacts for staging pipeline integrity.
      - name: Validate output artifacts
        run: |
          test -f docs/kartuli-llm.txt
          test -f tools/web-docs-client/.vitepress/dist/index.html
          test -f tools/web-docs-client/.vitepress/dist/assets/kartuli-llm.txt
